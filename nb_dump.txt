
---CELL 0 (code)---
%%capture
# 필요한 패키지 일괄 설치 (코랩 등 환경에서 실행 시)
!pip install -q crewai==0.36.0 pandas>=2.0.0 openai>=1.0.0 langchain

---CELL 1 (markdown)---
# Step 1: Data Preprocessing for AI Vet Consultant

이 노트북에서는 AI 수의사 상담 시스템을 위한 데이터를 준비합니다.
CSV 파일에 있는 반려동물의 증상과 정보를 AI 모델이 이해하기 쉬운 **프롬프트 형식**으로 변환하는 과정을 실습합니다.

---CELL 2 (code)---
import pandas as pd
import os

# 데이터 경로 설정 (더 큰 데이터셋 사용)
INPUT_CSV_PATH = "../00_datasets/dr.tail/Dr.tail_210.CSV"
OUTPUT_DIR = "./data"

# 출력 디렉토리 생성
if not os.path.exists(OUTPUT_DIR):
    os.makedirs(OUTPUT_DIR)
    print(f"Created directory: {OUTPUT_DIR}")

---CELL 3 (code)---
import requests
import os

# User provided URL for processed_sample.csv
DOWNLOAD_URL = "https://raw.githubusercontent.com/pon07029/04_student_exercise/main/data/processed_sample.csv"
OUTPUT_DIR = "./data"
OUTPUT_FILENAME = "processed_sample.csv"

# Ensure output directory exists
if not os.path.exists(OUTPUT_DIR):
    os.makedirs(OUTPUT_DIR)

output_path = os.path.join(OUTPUT_DIR, OUTPUT_FILENAME)

try:
    response = requests.get(DOWNLOAD_URL)
    response.raise_for_status() # Raise an HTTPError for bad responses (4xx or 5xx)

    with open(output_path, "wb") as f:
        f.write(response.content)
    print(f"Successfully downloaded and saved {OUTPUT_FILENAME} to {output_path}")
except requests.exceptions.RequestException as e:
    print(f"Error downloading file from {DOWNLOAD_URL}: {e}")
except Exception as e:
    print(f"An unexpected error occurred: {e}")

---CELL 4 (markdown)---
## Downloaded `processed_sample.csv` from User-Provided URL

위에서 생성된 `processed_sample.csv` 파일 대신, 사용자가 제공한 URL에서 최신 `processed_sample.csv` 파일을 다운로드하여 사용합니다. 이 파일은 이후의 모든 에이전트 작업 및 평가 단계에서 활용됩니다.

---CELL 5 (markdown)---
## 1. 데이터 로드 및 확인
Pandas를 사용하여 CSV 파일을 읽고 데이터 구조를 확인합니다. 실습을 위해 5개만 샘플링합니다.

---CELL 6 (code)---
try:
    df_raw = pd.read_csv(output_path)
    df = df_raw.head(5).copy()
    print(f"Successfully loaded dataset. Using first {len(df)} cases for exercise.")
    display(df.head(2))
except FileNotFoundError:
    print(f"Error: File not found at {INPUT_CSV_PATH}")

---CELL 7 (markdown)---
## 2. 프롬프트 포맷팅 함수 작성 (실습)
각 행(Row)의 정보를 하나의 완성된 질문(Prompt) 텍스트로 합치는 함수를 작성해 봅시다.

**목표 형식:**
```
증상 (Symptom):
[증상 내용]

반려동물 정보 (Pet Information):
[반려동물 정보]

상세 문제 (Issue Details):
[상세 문제]

보호자 추가 설명 (More Details from Guardian):
[보호자 추가 설명]
```

---CELL 8 (code)---
def format_input_from_row(row):
    """Pandas 데이터프레임의 한 행을 받아 AI 입력 형식 문자열로 변환합니다."""

    # 1. 데이터 추출 (없는 경우 빈 문자열 처리)
    symptom = str(row.get('symptom', ''))
    pet_info = str(row.get('pet_information', ''))
    issue_details = str(row.get('issue_details', ''))
    more_details = str(row.get('more_details', ''))

    # 2. 포맷팅 (여기에 코드를 작성하세요)
    full_description = f"""
증상 (Symptom):
{symptom}

반려동물 정보 (Pet Information):
{pet_info}

상세 문제 (Issue Details):
{issue_details}

보호자 추가 설명 (More Details from Guardian):
{more_details}
"""
    return full_description.strip()

# 테스트: 첫 번째 행으로 결과 확인
if not df.empty:
    sample_row = df.iloc[0]
    print(format_input_from_row(sample_row))

---CELL 9 (markdown)---
## 3. 전체 데이터 변환 및 저장
모든 데이터에 이 함수를 적용하고, 나중에 사용할 수 있도록 저장합니다.

---CELL 10 (code)---
# 새로운 컬럼 'formatted_prompt' 생성
df['formatted_prompt'] = df.apply(format_input_from_row, axis=1)

# 필요한 컬럼만 선택하여 저장 (Prompt와 정답 Answer)
df_processed = df[['formatted_prompt', 'answer']]

output_path = os.path.join(OUTPUT_DIR, "processed_sample.csv")
df_processed.to_csv(output_path, index=False, encoding='utf-8-sig')

print(f"Saved {len(df_processed)} processed cases to {output_path}")
display(df_processed.head(1))

---CELL 11 (markdown)---
# Step 2: Single Agent Consultation

이 단계에서는 CrewAI의 가장 기본적인 단위인 **Single Agent(단일 에이전트)**를 만들어 봅니다.
복잡한 도구 없이, LLM의 지식만으로 반려동물의 증상을 분석하고 조언을 제공하는 '종합 수의사' 에이전트를 구현합니다.

---CELL 12 (code)---
# 필요한 라이브러리 설치 (최초 1회 실행)
try:
    import crewai
except ImportError:
    print("Installing crewai and dependencies...")
    !pip install crewai pandas openai

import os
import pandas as pd
from crewai import Agent, Task, Crew, LLM

# 환경 변수 설정 (API 키 하드코딩)
os.environ["OPENAI_API_KEY"] = "ENTER THE API KEY"
os.environ["OPENAI_MODEL_NAME"] = "gpt-5-mini" # 기본 모델 설정


---CELL 13 (markdown)---
## 1. LLM 설정
에이전트가 사용할 두뇌(LLM)를 설정합니다. 여기서는 gpt-5-mini를 사용합니다.

---CELL 14 (code)---
# LLM 설정
my_llm = LLM(
    model="gpt-5-mini",
    temperature=1
)

---CELL 15 (markdown)---
## 2. Agent 정의 (실습)
**`Agent`**는 특정 역할을 수행하는 AI 직원입니다.
- **Role**: 직책 (예: Pet Health Consultant)
- **Goal**: 목표 (예: 증상을 분석하여 조언 제공)
- **Backstory**: 배경 설정 (예: 10년 경력의 수의사...)

---CELL 16 (code)---
pet_consultant = Agent(
    role="종합 반려동물 건강 컨설턴트",
    goal="""
        보호자가 제공한 반려동물의 증상을 분석하고 종합적인 수의학 상담을 제공합니다.
        긴급도를 평가하고, 예상되는 원인을 제시하며, 실질적인 조언을 한국어로 작성합니다.
    """,
    backstory="""
        당신은 따뜻한 마음을 가진 경험 풍부한 수의사입니다.
        걱정하는 반려인들을 위해 복잡한 의학적 문제를 알기 쉬운 말로 설명하는 데 탁월한 능력을 갖추고 있습니다.
        당신은 항상 동물의 안전과 웰빙을 최우선으로 생각합니다.
    """,
    llm=my_llm,
    verbose=True
)

---CELL 17 (markdown)---
## 3. Task 정의 (실습)
**`Task`**는 에이전트가 수행해야 할 구체적인 작업입니다.
- **Description**: 작업 내용 (구체적으로 작성)
- **Expected Output**: 결과물의 형식

---CELL 18 (code)---
consultation_task = Task(
    description="""
        다음 반려동물 건강 케이스를 분석하세요:
        <case>
        {case_input}
        </case>

        당신의 분석에는 반드시 다음 내용이 포함되어야 하며 모든 내용은 한국어로 작성해야 합니다:
        1. 긴급도 평가 (위급, 응급, 긴급, 비긴급)
        2. 예상되는 원인 (감별 진단)
        3. 보호자를 위한 향후 권장 조치 및 조언
    """,
    expected_output="""
        마크다운 형식으로 작성된 전문적인 수의학 상담 리포트.
        '긴급도', '예상 원인', '권장 조치' 섹션을 포함해야 하며, 모든 내용은 한국어로 작성되어야 합니다.
    """,
    agent=pet_consultant
)

---CELL 19 (markdown)---
## 4. Crew 실행 (반복)
Agent와 Task를 하나로 묶어 **`Crew`**를 만들고 실행합니다.
Step 1에서 만든 5개의 데이터를 순회하며 모두 실행해 봅니다.

---CELL 20 (code)---
# 1. 데이터 로드
df_processed = pd.read_csv("./data/processed_sample.csv")
print(f"Loaded {len(df_processed)} cases.")

# 2. Crew 생성
single_agent_crew = Crew(
    agents=[pet_consultant],
    tasks=[consultation_task],
    verbose=True
)

# 3. 반복 실행 및 저장
outputs = []
for i, row in df_processed.iterrows():
    print(f"\n--- Processing Case #{i+1} ---")
    case_input = row['formatted_prompt']

    result = single_agent_crew.kickoff(inputs={"case_input": case_input})
    outputs.append(result.raw)

    # 개별 결과 저장
    with open(f"./data/single_result_{i}.md", "w", encoding="utf-8") as f:
        f.write(result.raw)

print("\nAll cases processed.")

---CELL 21 (markdown)---
# Step 3: Multi-Agent Crew Consultation

이 단계에서는 **Multi-Agent System(멀티 에이전트 시스템)**을 구축합니다.
단 하나의 '슈퍼맨' 에이전트 대신, 각자의 전문 분야를 가진 여러 에이전트(Triage, Vet, Advisor)가 협력하여 더 정확하고 풍부한 상담 결과를 만들어내는 과정을 실습합니다.

---CELL 22 (code)---

# LLM 설정
my_llm = LLM(model="gpt-5-mini", temperature=1)

---CELL 23 (markdown)---
## 1. 전문 에이전트 정의 (실습)
세 명의 전문가를 고용합니다.

1.  **Triage Specialist (초진 담당)**: 응급도를 판단하고 분류합니다.
2.  **Veterinary Consultant (진단 담당)**: 증상을 바탕으로 의학적 진단을 내립니다.
3.  **Client Advisor (보호자 상담 담당)**: 어려운 의학 용어를 쉽게 풀어서 보호자에게 전달합니다.

---CELL 24 (code)---
# 1. Triage Agent
triage_agent = Agent(
    role="응급 분류 간호사 (Triage Specialist)",
    goal="증상을 바탕으로 반려동물 상태의 긴급도를 가장 먼저 분류합니다.",
    backstory="""당신은 경험 많은 동물병원 응급실 간호사입니다. 생명이 위급한 징후를 빠르게 파악하고
    케이스를 위급, 응급, 긴급, 또는 비긴급 카테고리로 신속하게 분류하는 능력을 갖추고 있습니다.""",
    llm=my_llm,
    verbose=True
)

# 2. Vet Consultant Agent
vet_agent = Agent(
    role="진단 수의사 (Veterinary Consultant)",
    goal="증상과 응급도를 파악하여 예상되는 질병과 의학적 설명을 제공합니다.",
    backstory="""당신은 깊은 의학적 지식을 갖춘 전문 수의사입니다.
    증상을 분석하여 가능한 질병 목록(감별 진단)을 논리적으로 추론해 냅니다.""",
    llm=my_llm,
    verbose=True
)

# 3. Advisor Agent
advisor_agent = Agent(
    role="상담가 (Pet Health Advisor)",
    goal="앞선 분석 결과를 종합하여 보호자를 위해 이해하기 쉽고 따뜻한 조언 리포트를 한국어로 작성합니다.",
    backstory="""당신은 고객 커뮤니케이션 전문가입니다. 복잡한 의학 정보를
    걱정하는 보호자가 명확하게 이해할 수 있도록 친절하게 설명하고 가정 내 대처법을 덧붙입니다.""",
    llm=my_llm,
    verbose=True
)

---CELL 25 (markdown)---
## 2. Task 연결 (Workflow 설계)
각 에이전트가 수행할 작업을 정의하고, **이전 작업의 결과(Context)**를 다음 작업이 받을 수 있도록 설정합니다.
CrewAI의 `sequential` 프로세스는 Task 리스트의 순서대로 작업을 실행합니다.

---CELL 26 (code)---
# Task 1: Triage Assessment
triage_task = Task(
    description="""다음 케이스의 긴급도를 분석하세요: {case_input}.
    Level 1 (위급) 부터 Level 5 (비긴급) 사이로 분류하고 그 이유를 한국어로 짧게 요약하세요.""",
    expected_output="한국어로 작성된 긴급도 분류 수준 및 그 판단 근거.",
    agent=triage_agent
)

# Task 2: Medical Diagnosis (Triage 기반 진단)
diagnosis_task = Task(
    description="""응급 분류 결과와 증상을 바탕으로 예상되는 진단명들을 나열하세요.
    필요하다면 어떤 검사가 요구되는지도 한국어로 제안해 주세요.""",
    expected_output="한국어로 작성된 예상 질병 목록과 권장되는 의학적 검사 방법.",
    agent=vet_agent,
    context=[triage_task] # Triage 결과 입력 받음
)

# Task 3: Final Advice (최종 조언 작성)
advice_task = Task(
    description="""응급 분류 결과와 수의사의 진단 결과를 꼼꼼히 종합하여 보호자를 위한 최종 답변을 작성하세요.
    긴급도, 예상 원인, 가정 내 대처법이 반드시 포함되어야 하며, 다정하고 친절한 어조를 사용하여 모든 문장을 한국어로 작성하세요.""",
    expected_output="한국어로 작성된 친절하고 완벽한 수의학 상담 최종 리포트.",
    agent=advisor_agent,
    context=[triage_task, diagnosis_task] # 이전 두 에이전트의 결과를 모두 종합
)

---CELL 27 (markdown)---
## 3. Crew 실행 (반복)
5개의 케이스에 대해 Multi-Agent 시스템을 실행합니다.

---CELL 28 (code)---
# 데이터 로드
df_processed = pd.read_csv("./data/processed_sample.csv")

# Crew 생성
multi_agent_crew = Crew(
    agents=[triage_agent, vet_agent, advisor_agent],
    tasks=[triage_task, diagnosis_task, advice_task],
    process=Process.sequential, # 순차 실행
    verbose=True
)

# 반복 실행
for i, row in df_processed.iterrows():
    print(f"\n--- Processing Case #{i+1} ---")
    case_input = row['formatted_prompt']

    result = multi_agent_crew.kickoff(inputs={"case_input": case_input})

    # 결과 저장
    with open(f"./data/multi_result_{i}.md", "w", encoding="utf-8") as f:
        f.write(result.raw)

print("\nAll cases processed.")

---CELL 29 (markdown)---
# Step 4: Evaluation (AI-as-a-Judge)

마지막 단계에서는 우리가 만든 AI 수의사들의 실력을 평가합니다.
사람이 직접 채점하는 대신, 또 다른 AI(LLM)에게 채점 기준표를 주고 평가를 맡기는 **Model-based Evaluation** 방식을 실습합니다.

---CELL 30 (code)---
import os
import pandas as pd
import json
from openai import OpenAI

client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])

---CELL 31 (markdown)---
## 1. 정답 및 결과 로드
5개 케이스 각각에 대한 정답과 에이전트들의 결과를 불러옵니다.

---CELL 32 (code)---
# 정답 데이터 로드
df_truth = pd.read_csv("./data/processed_sample.csv")
print(f"Loaded {len(df_truth)} ground truth cases.")

# 결과 로드 함수
def load_result(path):
    if os.path.exists(path):
        with open(path, "r", encoding="utf-8") as f:
            return f.read()
    return ""

# 모든 결과를 리스트로 로드
single_results = []
multi_results = []

for i in range(len(df_truth)):
    single_results.append(load_result(f"./data/single_result_{i}.md"))
    multi_results.append(load_result(f"./data/multi_result_{i}.md"))

---CELL 33 (markdown)---
## 2. 평가 함수 작성
채점관 AI에게 줄 '채점 기준표'를 작성합니다.
정확성(Accuracy), 구체성(Completeness), 공감능력(Empathy) 세 가지 항목으로 평가하도록 지시합니다.

---CELL 34 (code)---
def evaluate_answer(answer, truth, problem_desc, criteria):
    prompt = f"""
    당신은 수의학 전문 평가자입니다.
    실제 수의사의 답변(Ground Truth)과 문제 상황(Problem Description)을 바탕으로 학생(AI)의 답변을 평가하세요.

    문제 상황 (Problem Description):
    {problem_desc}

    실제 수의사 정답 (Ground Truth):
    {truth}

    학생 AI 답변:
    {answer}

    평가 기준:
    {criteria}

    평가 결과는 반드시 아래와 같은 정확한 구조의 JSON 객체로 제공해야 합니다:
    {{
      "Accuracy": {{"score": 0, "reasoning": "text"}},
      "Completeness": {{"score": 0, "reasoning": "text"}},
      "Empathy": {{"score": 0, "reasoning": "text"}}
    }}
    (0을 0-10 사이의 점수로, text를 한국어로 작성된 점수 부여 사유로 교체하세요).
    """

    try:
        response = client.chat.completions.create(
            model="gpt-5-mini",
            messages=[{"role": "user", "content": prompt}],
            response_format={"type": "json_object"}
        )
        return json.loads(response.choices[0].message.content)
    except Exception as e:
        print(f"Evaluation failed: {e}")
        return None



---CELL 35 (markdown)---
## 3. 평가 실행 (반복)
모든 케이스에 대해 점수를 매기고 평균을 냅니다.

---CELL 36 (code)---
criteria = """
1. Accuracy (정확성): 의학적 조언이 올바르고 안전한가?
2. Completeness (완전성): 긴급도, 원인, 가정 내 대처법을 모두 다루었는가?
3. Empathy (공감능력): 걱정하는 보호자에게 적절하고 친절한 어조인가?
"""

all_single_scores = []
all_multi_scores = []
all_vet_scores = []

for i in range(len(df_truth)):
    print(f"Evaluating Case #{i+1}...")
    ground_truth = df_truth.iloc[i]['answer']
    problem_desc = df_truth.iloc[i]['formatted_prompt']

    s_score = evaluate_answer(single_results[i], ground_truth, problem_desc, criteria)
    m_score = evaluate_answer(multi_results[i], ground_truth, problem_desc, criteria)
    v_score = evaluate_answer(ground_truth, ground_truth, problem_desc, criteria)

    if s_score: all_single_scores.append(s_score)
    if m_score: all_multi_scores.append(m_score)
    if v_score: all_vet_scores.append(v_score)

# 결과를 DataFrame으로 정리하여 평균 계산
def get_avg_scores(scores_list):
    if not scores_list: return {}
    avg = {'Accuracy': 0, 'Completeness': 0, 'Empathy': 0}
    for s in scores_list:
        avg['Accuracy'] += s['Accuracy']['score']
        avg['Completeness'] += s['Completeness']['score']
        avg['Empathy'] += s['Empathy']['score']
    for k in avg:
        avg[k] /= len(scores_list)
    return avg

avg_single = get_avg_scores(all_single_scores)
avg_multi = get_avg_scores(all_multi_scores)
avg_vet = get_avg_scores(all_vet_scores)

print("\n--- Average Single Agent Scores ---")
print(avg_single)
print("\n--- Average Multi Agent Scores ---")
print(avg_multi)
print("\n--- Average Vet (Ground Truth) Scores ---")
print(avg_vet)


---CELL 37 (code)---
# 시각화
import matplotlib.pyplot as plt

if avg_single and avg_multi and avg_vet:
    df_scores = pd.DataFrame({
        'Metric': list(avg_single.keys()),
        'Single Agent': list(avg_single.values()),
        'Multi Agent': list(avg_multi.values()),
        'Vet (Ground Truth)': list(avg_vet.values())
    })

    df_scores.set_index('Metric').plot(kind='bar', ylim=(0, 10), rot=0)
    plt.title('Performance Comparison (Avg of 5 Cases)')
    plt.ylabel('Score (0-10)')
    plt.show()

